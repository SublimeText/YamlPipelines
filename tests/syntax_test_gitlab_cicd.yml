# SYNTAX TEST "Packages/YamlPipelines/Gitlab CICD.sublime-syntax"
variables:
# ^^^^^^^ meta.mapping.key meta.string string.unquoted.plain.out - entity
#        ^ meta.mapping punctuation.separator.key-value.mapping
  DEPLOY_SITE: "https://example.com/"

build-job:
# ^^^^^^^ entity.name.label
#        ^ punctuation.separator.key-value - entity
  stage: build
# ^^^^^^^^^^^^^ - entity
  script:
# ^^^^^^ string.unquoted.plain.out keyword.control.flow.script
#       ^ punctuation.separator.key-value
    - echo "Hello, $GITLAB_USER_LOGIN!"
#   ^ punctuation.definition.block.sequence.item
#     ^^^^ source.shell meta.function-call.identifier support.function
  after_script:
# ^^^^^^^^^^^^ string.unquoted.plain.out keyword.control.flow.script
#             ^ punctuation.separator.key-value
    - echo "Execute this command after the `script` section completes."
#   ^ punctuation.definition.block.sequence.item
#     ^^^^ source.shell meta.function-call.identifier support.function
  before_script:
# ^^^^^^^^^^^^^ string.unquoted.plain.out keyword.control.flow.script
#              ^ punctuation.separator.key-value
    - echo "Execute this `before_script` in all jobs by default."
#   ^ punctuation.definition.block.sequence.item
#     ^^^^ source.shell meta.function-call.identifier support.function

# <- - source.shell
test-job1:
# ^^^^^^^ entity.name.label
#        ^ punctuation.separator.key-value - entity
  stage: test
# ^^^^^ meta.mapping.key meta.string string.unquoted.plain.out - entity
  script:
# ^^^^^^ string.unquoted.plain.out keyword.control.flow.script
#       ^ punctuation.separator.key-value
    - echo "This job tests something"
#^^^^^ meta.block.script.pipeline - source.shell
#     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ meta.block.script.pipeline source.shell.bash.embedded
#^^^ - punctuation
#   ^ punctuation.definition.block.sequence.item
#    ^ - punctuation
      "...with line continued here"
#^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ meta.block.script.pipeline source.shell.bash.embedded
#     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ meta.string.glob.shell string.quoted.double.shell
#     ^ punctuation.definition.string.begin.shell
#                                 ^ punctuation.definition.string.end.shell
    - var="$(echo "$CI_COMMIT_TAG"
      | grep -Eo '\d+\.\d+\.\d+(-?(a(lpha)?|b(eta)?|rc)\.?\d+)?$'
      || echo "$CI_COMMIT_REF_SLUG")"
#^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ meta.block.script.pipeline source.shell.bash.embedded meta.string
#     ^^ keyword.operator.logical.shell
#        ^^^^ meta.function-call.identifier.shell support.function.shell
#             ^^^^^^^^^^^^^^^^^^^^^ meta.function-call.arguments.shell meta.string
#                                 ^ punctuation.definition.string.end.shell
#                                  ^ punctuation.section.interpolation.end.shell
#                                   ^ punctuation.definition.string.end.shell
    - 'echo "\$RENOVATE_EXTRA_FLAGS: $RENOVATE_EXTRA_FLAGS"'
#^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ meta.block.script.pipeline
#     ^ meta.string.yaml string.quoted.single.yaml punctuation.definition.string.begin.yaml - source.shell
#      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ meta.string.yaml source.shell.bash.embedded
#                                                          ^ meta.string.yaml string.quoted.single.yaml - source.shell
#      ^^^^ meta.function-call.identifier.shell support.function.shell
#          ^ meta.function-call.arguments.shell - meta.function-call meta.string
#           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ meta.function-call.arguments.shell meta.string.glob.shell
#                                                         ^ punctuation.definition.string.end.shell
#                                                          ^ punctuation.definition.string.end.yaml
    - 'echo "\$RENOVATE_EXTRA_FLAGS:
      # <- meta.string.yaml string.quoted.single.yaml punctuation.definition.string.begin.yaml - source.shell
      # ^^^^^^^^^^^^^^^^^^^^^^^^^^^^ meta.string.yaml source.shell.bash.embedded
      $RENOVATE_EXTRA_FLAGS"'
#     ^^^^^^^^^^^^^^^^^^^^^^ meta.function-call.arguments.shell meta.string.glob.shell
#                          ^ punctuation.definition.string.end.shell
#                           ^ meta.string.yaml string.quoted.single.yaml punctuation.definition.string.end.yaml - source.shell
  - |
# ^^^ meta.block.script.pipeline - meta.block.script meta.block.script - source.shell
# ^ punctuation.definition.block.sequence.item
#   ^ keyword.control.flow.block-scalar.literal
    echo "First command line."
    # <- meta.block.script.pipeline source.shell.bash.embedded
    #^^^^^^^^^^^^^^^^^^^^^^^^^^ meta.block.script.pipeline source.shell.bash.embedded
    #^^^ meta.function-call.identifier support.function
    echo "Second command line."
    # <- meta.block.script.pipeline source.shell.bash.embedded
    #^^^^^^^^^^^^^^^^^^^^^^^^^^ meta.block.script.pipeline source.shell.bash.embedded
    #^^^ meta.function-call.identifier support.function
    echo "Third command line."
    # <- meta.block.script.pipeline source.shell.bash.embedded
    #^^^^^^^^^^^^^^^^^^^^^^^^^^ meta.block.script.pipeline source.shell.bash.embedded
    #^^^ meta.function-call.identifier support.function

test-job2:
# <- - source.shell
  stage: test
  script:
    - echo "This job tests something, but takes more time than test-job1."
    - echo "After the echo commands complete, it runs the sleep command for 20 seconds"
    - echo "which simulates a test that runs 20 seconds longer than test-job1"
    - sleep 20

deploy-prod:
  stage: deploy
  script:
    - echo "This job deploys something from the $CI_COMMIT_BRANCH branch."
  environment: production


build osx:
  stage: build
  script: make build:osx
  artifacts:
    paths:
      - binaries/

build linux:
# ^^^^^^^^^ entity.name.label
#          ^ punctuation.separator.key-value
  stage: build
  script: make build:linux
  artifacts:
    paths:
      - binaries/

test osx:
  stage: test
  script: make test:osx
  dependencies:
    - build osx

test linux:
  stage: test
  script: make test:linux
  dependencies:
    - build linux

deploy:
  stage: deploy
  script: make deploy
  environment: production

.npm-test:
# <- entity.name.label
#^^^^^^^^ entity.name.label
#        ^ punctuation.separator.key-value
  extends: .npm-test-job
  artifacts:
    when: always
    reports:
      junit: "**/reports/**/*.xml"
    paths:
      - coverage
      - reports
  script:
    - npm run test

.npm-deploy-gitlab:
  extends: .npm-deploy-job
  before_script:
    - *set-gitlab-token
#   ^ meta.block.script punctuation.definition.block.sequence.item - meta.block.script meta.block.script
#     ^ meta.block.script keyword.control.flow.alias punctuation.definition.alias - meta.block.script meta.block.script
#      ^^^^^^^^^^^^^^^^ meta.block.script variable.other.alias - meta.block.script meta.block.script
    - *setup-node-modules
#   ^ meta.block.script punctuation.definition.block.sequence.item - meta.block.script meta.block.script
#     ^ meta.block.script keyword.control.flow.alias punctuation.definition.alias - meta.block.script meta.block.script
#      ^^^^^^^^^^^^^^^^^^ meta.block.script variable.other.alias - meta.block.script meta.block.script
    - *setup-gitlab-registry
  script:
    - npm publish --registry "https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/packages/npm/"


release-finish:
  extends: release
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^release\//
      when: manual
  script:
    - NEW_VERSION="${NEW_VERSION:-${CI_COMMIT_BRANCH#release/}}"
    # folding block
    - >
      # <- keyword.control.flow.block-scalar.folded.yaml
      mvn
      --batch-mode
      # ^^^^^^^^^^ source.shell meta.function-call.arguments meta.parameter.option variable.parameter.option
      $MAVEN_CLI_OPTS_DEFAULT
      $MAVEN_CLI_OPTS
      $MAVEN_GITFLOW_CLI_OPTS
      gitflow:release-finish
      # ^^^^^^^^^^^^^^^^^^^^^ source.shell meta.function-call.arguments - variable
      -DpushRemote=true
      -DreleaseVersion="${NEW_VERSION}"
      #^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ source.shell meta.function-call.arguments
      #               ^ keyword.operator.assignment
      #                ^^^^^^^^^^^^^^^^ meta.string
      #                   ^^^^^^^^^^^ meta.interpolation.parameter variable.other.readwrite
      -DskipTestProject=true
    # non-folding block
    - |- # Add commit sha and "project-level internal id" for non-tag build since we cannot replace images.
      # <- keyword.control.flow.block-scalar.literal.yaml
      #^ storage.modifier.chomping-indicator.yaml
      if [ -n $CI_COMMIT_TAG ]; then
      # <- keyword.control.conditional.if.shell
        export CLOUD_REGISTRY_TAG="${DOCKER_TAG}"
      # ^^^^^^ support.function.shell
      else
      # <- keyword.control.conditional.else.shell
        export CLOUD_REGISTRY_TAG="${DOCKER_TAG}-${CI_COMMIT_SHORT_SHA}-${CI_PIPELINE_IID}"
      # ^^^^^^ support.function.shell
      fi;
      # ^ punctuation.terminator.statement.shell
      echo $CLOUD_REGISTRY_TAG
      # <- source.shell support.function
include:
  - local: setup.yml

.teardown:
  after_script:
    - echo deleting environment

test:
  script:
    - !reference [.setup, script]
#   ^ punctuation.definition.block.sequence.item
#     ^^^^^^^^^^ meta.property storage.type.tag-handle
#                ^^^^^^^^^^^^^^^^ meta.sequence.flow
#                ^ punctuation.definition.sequence.begin
#                 ^^^^^^ constant.other.label
#                       ^ punctuation.separator.sequence
#                         ^^^^^^ keyword.other
#                               ^ punctuation.definition.sequence.end
#                                ^ - meta.sequence
    - echo running my own command
#   ^ meta.block.script punctuation.definition.block.sequence.item
#     ^^^^ source.shell.bash meta.function-call.identifier support.function
  after_script:
    - !reference [.teardown, after_script]

.vars:
  variables:
    URL: "http://my-url.internal"
    IMPORTANT_VAR: "the details"

test-vars-1:
  variables: !reference [.vars, variables]
  script:
    - printenv

test-vars-2:
  variables:
    MY_VAR: !reference [.vars, variables, IMPORTANT_VAR]
    #       ^^^^^^^^^^ meta.property storage.type.tag-handle
    #                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ meta.sequence.flow
    #                  ^ punctuation.definition.sequence.begin
    #                   ^^^^^ constant.other.label
    #                        ^ punctuation.separator.sequence
    #                          ^^^^^^^^^ keyword.other
    #                                   ^ punctuation.separator.sequence
    #                                     ^^^^^^^^^^^^^ variable.other.constant
  script:
    - printenv

job1:
  artifacts:
    paths:
      - binaries/
      - .config

job2:
  artifacts:
    paths: !reference [job1, artifacts, paths, further_nesting]
#          ^^^^^^^^^^ meta.property storage.type.tag-handle
#                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ meta.sequence.flow
#                      ^^^^ constant.other.label
#                          ^ punctuation.separator.sequence
#                            ^^^^^^^^^ keyword.other
#                                     ^ punctuation.separator.sequence
#                                       ^^^^^ variable.other.constant
#                                            ^ punctuation.separator.sequence
#                                              ^^^^^^^^^^^^^^^ variable.other.constant
#                                                             ^ punctuation.definition.sequence.end
